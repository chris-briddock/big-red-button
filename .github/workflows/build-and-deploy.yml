name: Build and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_track:
        description: 'Release track for Google Play Store'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - beta
          - production

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./src/bigredbutton
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./src/bigredbutton/package-lock.json

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🧪 Run tests
        run: npm test -- --watchAll=false

      - name: 📊 Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          directory: ./src/bigredbutton/coverage
        env: 
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./src/bigredbutton
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./src/bigredbutton/package-lock.json

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔍 Run ESLint
        run: npm run lint

      - name: 🎨 Check TypeScript
        run: npx tsc --noEmit

  build-preview:
    name: Build Preview (Android)
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'pull_request' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    defaults:
      run:
        working-directory: ./src/bigredbutton
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./src/bigredbutton/package-lock.json

      - name: 🏗 Setup EAS CLI
        run: npm install --global eas-cli

      - name: 📦 Install dependencies
        run: npm ci

      - name: ✅ Verify EAS setup
        run: |
          eas whoami || eas login --token $EXPO_TOKEN
          eas project:info
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🚀 Build preview
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Building preview for PR..."
            eas build --platform android --profile preview --non-interactive
          else
            echo "Building preview for main branch (prerequisite for production)..."
            eas build --platform android --profile preview --non-interactive
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-production:
    name: Build Production
    runs-on: ubuntu-latest
    needs: [test, lint, build-preview]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    defaults:
      run:
        working-directory: ./src/bigredbutton
    
    strategy:
      matrix:
        platform: [android]
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./src/bigredbutton/package-lock.json

      - name: 🏗 Setup EAS CLI
        run: npm install --global eas-cli

      - name: 📦 Install dependencies
        run: npm ci

      - name: ✅ Verify EAS setup
        run: |
          eas whoami || eas login --token $EXPO_TOKEN
          eas project:info
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🚀 Build production
        run: eas build --platform ${{ matrix.platform }} --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  submit-to-store:
    name: Submit to Google Play Store
    runs-on: ubuntu-latest
    needs: [build-production]
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./src/bigredbutton

    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./src/bigredbutton/package-lock.json

      - name: 🏗 Setup EAS CLI
        run: npm install --global eas-cli

      - name: 📦 Install dependencies
        run: npm ci

      - name: ✅ Verify EAS setup
        run: |
          eas whoami || eas login --token $EXPO_TOKEN
          eas project:info
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🔑 Setup Google Service Account
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' > google-service-account-key.json

      - name: 🏪 Submit to Google Play Store
        run: |
          TRACK="${{ github.event.inputs.release_track || 'internal' }}"
          echo "Submitting to Google Play Store - Track: $TRACK"

          case $TRACK in
            "internal")
              PROFILE="production"
              ;;
            "beta")
              PROFILE="beta"
              ;;
            "production")
              PROFILE="release"
              ;;
            *)
              echo "Invalid release track: $TRACK"
              exit 1
              ;;
          esac

          echo "Using EAS profile: $PROFILE"
          eas submit --platform android --profile $PROFILE --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🧹 Cleanup
        if: always()
        run: |
          rm -f google-service-account-key.json

  update-ota:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    defaults:
      run:
        working-directory: ./src/bigredbutton
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./src/bigredbutton/package-lock.json

      - name: 🏗 Setup EAS CLI
        run: npm install --global eas-cli

      - name: 📦 Install dependencies
        run: npm ci

      - name: ✅ Verify EAS setup
        run: |
          eas whoami || eas login --token $EXPO_TOKEN
          eas project:info
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 🚀 Publish update
        run: eas update --branch preview --message "Automated OTA update from develop branch"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-production]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: 📢 Notify success
        if: needs.build-production.result == 'success'
        run: |
          echo "✅ Production build completed successfully!"
          echo "Check your Expo dashboard for download links."

      - name: 📢 Notify failure
        if: needs.build-production.result == 'failure'
        run: |
          echo "❌ Production build failed!"
          echo "Check the logs for details."
